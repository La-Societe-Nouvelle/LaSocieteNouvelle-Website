applications:
  app:
    source:
      root: "/"

    # Version de Node.js
    type: "nodejs:20"

    build:
      flavor: none

    # Hooks de build
    hooks:
      build: |
        set -e
        echo "Installing dependencies..."
        npm ci --prefer-offline --no-audit
        echo "Building Next.js application..."
        npm run build

      deploy: |
        echo "Application deployed successfully"

    # Configuration du serveur web
    web:
      commands:
        start: "npm start -- -p $PORT"

      locations:
        "/":
          passthru: true
          allow: false

        # Cache pour les assets statiques Next.js
        "/_next/static":
          allow: true
          expires: 1y
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|woff2?)$:
              allow: true

        # Fichiers publics
        "/public":
          allow: true
          root: "public"
          expires: 1h
          rules:
            \.(css|js|gif|jpe?g|png|svg|ico|pdf|woff2?)$:
              allow: true

    # Montage pour le cache Next.js (persistant entre les déploiements)
    mounts:
      "/.next/cache":
        source: storage
        source_path: next_cache

    # Variables d'environnement
    variables:
      env:
        NODE_ENV: "production"
         # Augmente la heap size Node.js à 1.5GB pour éviter les crashes mémoire
        NODE_OPTIONS: "--max-old-space-size=1536"

# Configuration des routes
routes:
  # Route par défaut pour tous les environnements (staging, preview, etc.)
  "https://{default}/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: true
      cookies: ["*"]

  # Route principale pour www.lasocietenouvelle.org (production uniquement)
  "https://www.lasocietenouvelle.org/":
    type: upstream
    upstream: "app:http"
    cache:
      enabled: true
      cookies: ["*"]

  # Redirection HTTP vers HTTPS pour www (production)
  "http://www.lasocietenouvelle.org/":
    type: redirect
    to: "https://www.lasocietenouvelle.org/"

  # Redirection du domaine racine vers www (production)
  "https://lasocietenouvelle.org/":
    type: redirect
    to: "https://www.lasocietenouvelle.org/"

  "http://lasocietenouvelle.org/":
    type: redirect
    to: "https://www.lasocietenouvelle.org/"

  # Redirection du sous-domaine data vers la page /databrowser (production)
  "https://data.lasocietenouvelle.org/":
    type: redirect
    to: "https://www.lasocietenouvelle.org/databrowser"

  # Redirection du sous-domaine docs vers la page /docs (production)
  "https://docs.lasocietenouvelle.org/":
    type: redirect
    to: "https://www.lasocietenouvelle.org/docs"
